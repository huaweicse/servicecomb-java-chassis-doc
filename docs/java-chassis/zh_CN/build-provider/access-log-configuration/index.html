<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Access Log配置 - ServiceComb Java Chassis 开发指南</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Access Log\u914d\u7f6e";
    var mkdocs_page_input_path = "build-provider/access-log-configuration.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> ServiceComb Java Chassis 开发指南</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <span class="caption-text">入门</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../start/terminology/">术语表</a>
                </li>
                <li class="">
                    
    <a class="" href="../../start/architecture/">微服务系统架构</a>
                </li>
                <li class="">
                    
    <a class="" href="../../start/development-environment/">安装本地开发环境</a>
                </li>
                <li class="">
                    
    <a class="" href="../../start/first-sample/">开发第一个微服务</a>
                </li>
                <li class="">
                    
    <a class="" href="../../featured-topics/application-porter/">完整例子-porter应用</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">开发服务提供者</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../definition/service-definition/">服务定义</a>
                </li>
                <li class="">
                    
    <a class="" href="../define-contract/">定义服务契约</a>
                </li>
                <li class="">
                    
    <a class="" href="../code-first/">使用隐式契约</a>
                </li>
                <li class="">
                    
    <a class="" href="../swagger-annotation/">使用Swagger注解</a>
                </li>
                <li class="">
                    
    <a class="" href="../springmvc/">用SpringMVC开发微服务</a>
                </li>
                <li class="">
                    
    <a class="" href="../jaxrs/">用JAX-RS开发微服务</a>
                </li>
                <li class="">
                    
    <a class="" href="../transparent-rpc/">用透明RPC开发微服务</a>
                </li>
                <li class="">
                    
    <a class="" href="../interface-constraints/">接口定义和数据类型</a>
                </li>
                <li class="">
                    
    <a class="" href="../listen-address-and-publish-address/">服务监听地址和发布地址</a>
                </li>
                <li class="">
                    
    <a class="" href="../thread-pool/">线程池</a>
                </li>
                <li class="">
                    
    <span class="caption-text">服务配置</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../configuration/ratelimite-strategy/">限流策略</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../configuration/downgrade-strategy/">降级策略</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../configuration/parameter-validator/">参数效验</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../bootup/">程序启动逻辑</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Access Log配置</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#_1">概念阐述</a></li>
    

    <li class="toctree-l3"><a href="#_2">场景描述</a></li>
    

    <li class="toctree-l3"><a href="#_3">配置说明</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#access-log">启用Access Log</a></li>
        
            <li><a class="toctree-l4" href="#_4">日志格式配置</a></li>
        
            <li><a class="toctree-l4" href="#_5">日志输出文件配置</a></li>
        
            <li><a class="toctree-l4" href="#logback">日志实现框架切换为logback</a></li>
        
            <li><a class="toctree-l4" href="#access-log_1">自定义扩展Access Log</a></li>
        
        </ul>
    

    <li class="toctree-l3"><a href="#_8">示例代码</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#microserviceyaml">microservice.yaml文件中的配置</a></li>
        
            <li><a class="toctree-l4" href="#log4jproperties">log4j.properties文件中的配置</a></li>
        
        </ul>
    

    </ul>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">开发服务消费者</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../build-consumer/common-configuration/">消费者通用配置项</a>
                </li>
                <li class="">
                    
    <a class="" href="../../build-consumer/using-resttemplate/">使用RestTemplate开发服务消费者</a>
                </li>
                <li class="">
                    
    <a class="" href="../../build-consumer/using-AsyncRestTemplate/">使用AsynRestTemplate开发服务消费者</a>
                </li>
                <li class="">
                    
    <a class="" href="../../build-consumer/develop-consumer-using-rpc/">使用RPC方式开发服务消费者</a>
                </li>
                <li class="">
                    
    <a class="" href="../../build-consumer/with-contract/">使用服务契约</a>
                </li>
                <li class="">
                    
    <span class="caption-text">调用控制</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../build-consumer/circuit-breaker/">熔断策略</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../build-consumer/flow-control/">限流策略</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../build-consumer/fault-injection/">故障注入</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../../build-consumer/3rd-party-service-invoke/">调用第三方REST服务</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Transports</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../transports/rest-over-servlet/">REST over Servlet</a>
                </li>
                <li class="">
                    
    <a class="" href="../../transports/rest-over-vertx/">REST over Vertx</a>
                </li>
                <li class="">
                    
    <a class="" href="../../transports/highway-rpc/">Highway</a>
                </li>
                <li class="">
                    
    <a class="" href="../../transports/http2/">HTTP2</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">通用开发</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../general-development/visit-sc/">访问服务中心</a>
                </li>
                <li class="">
                    
    <a class="" href="../../general-development/metrics/">应用性能监控</a>
                </li>
                <li class="">
                    
    <a class="" href="../../general-development/microservice-invocation-chain/">微服务调用链</a>
                </li>
                <li class="">
                    
    <a class="" href="../../general-development/customized-tracing/">自定义调用链打点</a>
                </li>
                <li class="">
                    
    <a class="" href="../../general-development/local-develop-test/">本地开发和测试</a>
                </li>
                <li class="">
                    
    <a class="" href="../../general-development/http-filter/">Http Filter</a>
                </li>
                <li class="">
                    
    <a class="" href="../../general-development/upload-download/">文件上传下载</a>
                </li>
                <li class="">
                    
    <a class="" href="../../general-development/reactive/">Reactive</a>
                </li>
                <li class="">
                    
    <a class="" href="../../general-development/dnsconfig/">DNS自定义配置</a>
                </li>
                <li class="">
                    
    <a class="" href="../../general-development/dai-li-she-zhi/">代理设置</a>
                </li>
                <li class="">
                    
    <a class="" href="../../general-development/report-framework-version/">框架上报版本号</a>
                </li>
                <li class="">
                    
    <a class="" href="../../general-development/cross-app-invocation/">跨应用调用</a>
                </li>
                <li class="">
                    
    <a class="" href="../../general-development/secret-field/">定制序列化和反序列化方法</a>
                </li>
                <li class="">
                    
    <a class="" href="../../general-development/context/">使用Context传递控制消息</a>
                </li>
                <li class="">
                    
    <a class="" href="../../general-development/produceprocess/">返回值序列化扩展</a>
                </li>
                <li class="">
                    
    <a class="" href="../../general-development/CORS/">CORS机制</a>
                </li>
                <li class="">
                    
    <a class="" href="../../general-development/AlarmEvent/">获取熔断与实例隔离告警事件信息</a>
                </li>
                <li class="">
                    
    <a class="" href="../../general-development/shutdown/">优雅停机</a>
                </li>
                <li class="">
                    
    <a class="" href="../../general-development/error-handling/">异常处理</a>
                </li>
                <li class="">
                    
    <a class="" href="../../general-development/multienvironment/">微服务实例间多环境隔离</a>
                </li>
                <li class="">
                    
    <a class="" href="../../general-development/thread-model/">线程模型</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">配置</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../config/general-config/">通用配置说明</a>
                </li>
                <li class="">
                    
    <a class="" href="../../config/inject-config/">配置注入说明</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">服务能力开放</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../edge/open-service/">介绍</a>
                </li>
                <li class="">
                    
    <a class="" href="../../edge/by-servicecomb-sdk/">使用Edge Service做边缘服务</a>
                </li>
                <li class="">
                    
    <a class="" href="../../edge/nginx/">使用confd和Nginx做边缘服务</a>
                </li>
                <li class="">
                    
    <a class="" href="../../edge/zuul/">使用zuul做边缘服务</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">服务打包和运行</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../packaging/standalone/">以standalone模式打包</a>
                </li>
                <li class="">
                    
    <a class="" href="../../packaging/web-container/">以WEB容器模式打包</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">微服务安全</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../security/tls/">使用TLS通信</a>
                </li>
                <li class="">
                    
    <a class="" href="../../security/shi-yong-rsa-ren-zheng/">使用RSA认证</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">专题文章</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../using-java-chassis-in-spring-boot/using-java-chassis-in-spring-boot/">在Spring Boot中使用java chassis</a>
                </li>
                <li class="">
                    
    <a class="" href="../../featured-topics/using-inspector/">使用 inspector 模块查看契约</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">处理链参考</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../references-handlers/intruduction/">处理链介绍</a>
                </li>
                <li class="">
                    
    <a class="" href="../../references-handlers/loadbalance/">负载均衡</a>
                </li>
                <li class="">
                    
    <a class="" href="../../references-handlers/publickey/">公钥认证</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../upgrading/1_to_2/">1.x迁移2.x指南</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">常见问题</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../question-and-answer/question_answer/">Q & A</a>
                </li>
                <li class="">
                    
    <a class="" href="../../question-and-answer/faq/">FAQ</a>
                </li>
                <li class="">
                    
    <a class="" href="../../question-and-answer/interface-compatibility/">微服务接口兼容常见问题</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">ServiceComb Java Chassis 开发指南</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>开发服务提供者 &raquo;</li>
        
      
    
    <li>Access Log配置</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h2 id="_1">概念阐述</h2>
<p>ServiceComb提供了基于Vert.x的access log功能。当用户使用REST over Vertx通信方式时，可以通过简单的配置启用access log打印功能。</p>
<h2 id="_2">场景描述</h2>
<p>用户在调试服务时可能需要开启access log。在使用REST over servlet通信方式的情况下，可以使用web容器的access log功能；而在使用REST over Vertx通信方式的情况下，可以使用ServiceComb提供的一套access log功能。</p>
<h2 id="_3">配置说明</h2>
<h3 id="access-log">启用Access Log</h3>
<p>用户需要在microservice.yaml文件中增加配置以启用access log，配置示例如下：</p>
<pre><code class="yaml">servicecomb:
  accesslog:
    enabled: true  ## 启用access log
</code></pre>

<p><em><strong>Access log 配置项说明</strong></em></p>
<table>
<thead>
<tr>
<th align="left">配置项</th>
<th align="left">取值范围</th>
<th align="left">默认值</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">servicecomb.accesslog.enabled</td>
<td align="left">true/false</td>
<td align="left">false</td>
<td align="left">如果为true则启用access log，否则不启用</td>
</tr>
<tr>
<td align="left">servicecomb.accesslog.pattern</td>
<td align="left">表示打印格式的字符串</td>
<td align="left">"%h - - %t %r %s %B"</td>
<td align="left">配置项见_<strong>日志元素说明表</strong>_</td>
</tr>
</tbody>
</table>
<blockquote>
<p><em><strong>说明：</strong></em></p>
<ul>
<li>以上两个配置项均可省略，若省略则使用默认值。</li>
</ul>
</blockquote>
<h3 id="_4">日志格式配置</h3>
<p>目前可用的日志元素配置项见 <strong><em>日志元素说明表(Apache &amp; W3C)</em></strong> 和 <strong><em>日志元素说明表(ServiceComb)</em></strong> 。</p>
<p><em><strong>日志元素说明表 (Apache &amp; W3C)</strong></em></p>
<table>
<thead>
<tr>
<th align="left">元素名称</th>
<th align="left">Apache日志格式</th>
<th align="left">W3C日志格式</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">HTTP method</td>
<td align="left">%m</td>
<td align="left">cs-method</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">HTTP status</td>
<td align="left">%s</td>
<td align="left">sc-status</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">Duration in second</td>
<td align="left">%T</td>
<td align="left">-</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">Duration in millisecond</td>
<td align="left">%D</td>
<td align="left">-</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">Remote hostname</td>
<td align="left">%h</td>
<td align="left">-</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">Local hostname</td>
<td align="left">%v</td>
<td align="left">-</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">Local port</td>
<td align="left">%p</td>
<td align="left">-</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">Size of response</td>
<td align="left">%B</td>
<td align="left">-</td>
<td align="left">如果消息体长度为零则打印"0"</td>
</tr>
<tr>
<td align="left">Size of response</td>
<td align="left">%b</td>
<td align="left">-</td>
<td align="left">如果消息体长度为零则打印"-"</td>
</tr>
<tr>
<td align="left">First line of request</td>
<td align="left">%r</td>
<td align="left">-</td>
<td align="left">包含HTTP Method、Uri、Http版本三部分内容</td>
</tr>
<tr>
<td align="left">URI path</td>
<td align="left">%U</td>
<td align="left">cs-uri-stem</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">Query string</td>
<td align="left">%q</td>
<td align="left">cs-uri-query</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">URI path and query string</td>
<td align="left">-</td>
<td align="left">cs-uri</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">Request protocol</td>
<td align="left">%H</td>
<td align="left">-</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">Datetime the request is received</td>
<td align="left">%t</td>
<td align="left">-</td>
<td align="left">按照默认设置打印时间戳，格式为"EEE, dd MMM yyyy HH:mm:ss zzz"，语言为英文，时区为GMT</td>
</tr>
<tr>
<td align="left">Configurable datetime the request is received</td>
<td align="left">%{PATTERN}t</td>
<td align="left">-</td>
<td align="left">按照指定的格式打印时间戳，语言为英文，时区为GMT</td>
</tr>
<tr>
<td align="left">Configurable datetime the request is received</td>
<td align="left">%{PATTERN&#124;TIMEZONE&#124;LOCALE}t</td>
<td align="left">-</td>
<td align="left">按照指定的格式、语言、时区打印时间戳。允许省略其中的某部分配置（但两个分隔符号"&#124;"不可省略）。</td>
</tr>
<tr>
<td align="left">Request header</td>
<td align="left">%{VARNAME}i</td>
<td align="left">-</td>
<td align="left">如果没有找到指定的header，则打印"-"</td>
</tr>
<tr>
<td align="left">Response header</td>
<td align="left">%{VARNAME}o</td>
<td align="left">-</td>
<td align="left">如果没有找到指定的header，则打印"-"</td>
</tr>
<tr>
<td align="left">Cookie</td>
<td align="left">%{VARNAME}C</td>
<td align="left">-</td>
<td align="left">如果没有找到指定的cookie，则打印"-"</td>
</tr>
</tbody>
</table>
<p><em><strong>日志元素说明表(ServiceComb)</strong></em></p>
<table>
<thead>
<tr>
<th align="left">Element</th>
<th align="left">Placeholder</th>
<th align="left">Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">TraceId</td>
<td align="left">%SCB-traceId</td>
<td align="left">打印ServiceComb生成的trace id，找不到则打印"-"</td>
</tr>
<tr>
<td align="left">Invocation Context</td>
<td align="left">%{VARNAME}SCB-ctx</td>
<td align="left">打印key为<code>VARNAME</code>的invocation context值，找不到则打印"-"</td>
</tr>
</tbody>
</table>
<h3 id="_5">日志输出文件配置</h3>
<p>Access log的日志打印实现框架默认采用Log4j，并提供了一套默认的日志文件配置。用户可以在自己定义的log4j.properties文件中覆写这些配置。用户可配置的日志文件配置项见下表。</p>
<p><em><strong>日志文件配置项</strong></em></p>
<table>
<thead>
<tr>
<th align="left">配置项</th>
<th align="left">默认值</th>
<th align="left">含义</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">paas.logs.accesslog.dir</td>
<td align="left">${paas.logs.dir}</td>
<td align="left">日志文件输出目录</td>
<td align="left">与普通日志输出到同一个目录中</td>
</tr>
<tr>
<td align="left">paas.logs.accesslog.file</td>
<td align="left">access.log</td>
<td align="left">日志文件名</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">log4j.appender.access.MaxBackupIndex</td>
<td align="left">10</td>
<td align="left">最大保存的日志滚动文件个数</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">log4j.appender.access.MaxFileSize</td>
<td align="left">20MB</td>
<td align="left">日志文件最大体积</td>
<td align="left">正在记录的文件达到此大小时触发日志滚动存储</td>
</tr>
<tr>
<td align="left">log4j.appender.access.logPermission</td>
<td align="left">rw-------</td>
<td align="left">日志文件权限</td>
<td align="left">-</td>
</tr>
</tbody>
</table>
<blockquote>
<p><em><strong>注意：</strong></em><br />
由于ServiceComb的日志打印功能只依赖slf4j的接口，因此用户可以选择其他日志打印框架，选择其他日志打印框架时需要用户自行配置日志文件输出选项。</p>
</blockquote>
<h3 id="logback">日志实现框架切换为logback</h3>
<blockquote>
<p>针对采用logback作为日志打印框架的项目，需要将日志打印框架依赖从Log4j改为logback并添加部分配置以使access log功能正常生效。</p>
</blockquote>
<h4 id="1-log4j">1. 排除Log4j依赖</h4>
<p>在将日志实现框架切换为logback之前，需要检查项目的依赖，从中排除掉Log4j相关的依赖项。在项目中运行maven命令<code>dependency:tree</code>，找出其中依赖了Log4j的ServiceComb组件，在其<code>&lt;dependency&gt;</code>依赖项中添加如下配置：</p>
<pre><code class="xml">&lt;exclusion&gt;
  &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
  &lt;artifactId&gt;slf4j-log4j12&lt;/artifactId&gt;
&lt;/exclusion&gt;
</code></pre>

<h4 id="2-logback">2. 添加logback依赖</h4>
<p>在pom文件中添加logback的依赖项：</p>
<pre><code class="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
  &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;
  &lt;artifactId&gt;logback-classic&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;
  &lt;artifactId&gt;logback-core&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>

<h4 id="3-access-loglogger">3. 配置access log组件的logger</h4>
<p>由于ServiceComb提供的日志打印组件是获取名为<code>accesslog</code>的logger来打印access log的，因此将日志实现框架从Log4j切换为logback的关键就是提供一个名为<code>accesslog</code>，并为其配置好日志输出文件。以下是access log在logback配置文件中的配置示例（本示例仅展示access log相关的配置，其他日志配置均省略）：</p>
<pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;configuration&gt;
  &lt;!-- 用户可根据需要自定义appender --&gt;
  &lt;appender name=&quot;ACCESSLOG&quot; class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;
    &lt;file&gt;./logs/access.log&lt;/file&gt;
    &lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;&gt;
      &lt;fileNamePattern&gt;./logs/access-%d{yyyy-MM-dd}.log&lt;/fileNamePattern&gt;
    &lt;/rollingPolicy&gt;
    &lt;!-- 注意：由于access log的内容是在代码中完成格式化的，因此这里只需输出message即可，无需添加额外的格式 --&gt;
    &lt;encoder&gt;
      &lt;pattern&gt;%msg%n&lt;/pattern&gt;
    &lt;/encoder&gt;
  &lt;/appender&gt;

  &lt;!-- 提供一个名为&quot;accesslog&quot;的logger供access log打印组件使用 --&gt;
  &lt;logger name=&quot;accesslog&quot; level=&quot;INFO&quot; additivity=&quot;false&quot;&gt;
    &lt;appender-ref ref=&quot;ACCESSLOG&quot; /&gt;
  &lt;/logger&gt;
&lt;/configuration&gt;
</code></pre>

<h3 id="access-log_1">自定义扩展Access Log</h3>
<p>用户可以利用ServiceComb提供的AccessLogItem扩展机制，定制自己的AccessLogItem。</p>
<h4 id="_6">相关类说明</h4>
<ol>
<li><code>AccessLogItem</code></li>
</ol>
<p><code>java
  public interface AccessLogItem&lt;T&gt; {
    /**
     * 从accessLogParam中获取特定的内容,组装成access log的打印内容并返回
     */
    String getFormattedItem(AccessLogParam&lt;T&gt; accessLogParam);
  }</code>
  <code>AccessLogItem</code>的定义如上所示，每一次请求触发Access Log打印时，ServiceComb的Access Log机制都会遍历有效的<code>AccessLogItem</code>，调用<code>getFormattedItem</code>方法获取此Item生成的Access Log片段，并将全部片段拼接成一条Access Log打印到日志文件中。
  参数<code>AccessLogParam&lt;T&gt;</code>包含请求开始时间、结束时间以及类型为<code>T</code>的请求上下文信息，在REST over Vertx通信方式中，类型<code>T</code>为Vert.x的<code>RoutingContext</code>。</p>
<ol>
<li><code>VertxRestAccessLogItemMeta</code></li>
</ol>
<p><code>java
  // pattern占位符前缀
  protected String prefix;
  // pattern占位符后缀
  protected String suffix;
  // 优先级序号
  protected int order;
  // AccessLogItem构造器
  protected AccessLogItemCreator&lt;RoutingContext&gt; accessLogItemCreator;</code>
  <code>VertxRestAccessLogItemMeta</code>包含如上属性，它定义了ServiceComb如何解析pattern字符串以获得特定的AccessLogItem。
  - 如果用户想要定义一个占位符为<code>%user-defined</code>的<code>AccessLogItem</code>，则需要声明一个<code>VertxRestAccessLogItemMeta</code>的子类，设置prefix="%user-defined"，suffix=null，当<code>AccessLogPatternParser</code>解析到"%user-defined"时，从此meta类中取得<code>AccessLogItemCreator</code>创建对应的<code>AccessLogItem</code>。<strong>注意</strong>：由于"%user-defined"占位符中没有变量部分，因此调用<code>AccessLogItemCreator</code>传入的配置参数为null。
  - 如果用户想要定义一个占位符为<code>%{VARNAME}user-defined</code>的<code>AccessLogItem</code>，则声明的<code>VertxRestAccessLogItemMeta</code>子类中，设置prefix="%{"，suffix="}user-defined"，当<code>AccessLogPatternParser</code>解析到"%{VARNAME}user-defined"时，会截取出"VARNAME"作为配置参数传入<code>AccessLogItemCreator</code>，创建一个<code>AccessLogItem</code>。</p>
<p><code>VertxRestAccessLogItemMeta</code>有一个子类<code>CompositeVertxRestAccessLogItemMeta</code>，当用户需要定义多个AccessLogItem时，可以将多个<code>VertxRestAccessLogItemMeta</code>聚合到<code>CompositeVertxRestAccessLogItemMeta</code>中。Parser加载到类型为<code>CompositeVertxRestAccessLogItemMeta</code>的AccessLogItemMeta时，会调用其<code>getAccessLogItemMetas()</code>方法获得一组AccessLogItemMeta。<code>VertxRestAccessLogItemMeta</code>使用SPI机制加载，而<code>CompositeVertxRestAccessLogItemMeta</code>可以让用户只在SPI配置文件中配置一条记录就加载多条meta信息，给了用户更灵活的选择。</p>
<ol>
<li><code>AccessLogItemCreator</code></li>
</ol>
<p><code>java
  public interface AccessLogItemCreator&lt;T&gt; {
    // 接收配置值，返回一个AccessLogItem。如果AccessLogItem的占位符没有可变的配置值部分，则此方法会接收到null。
    AccessLogItem&lt;T&gt; createItem(String config);
  }</code></p>
<p>用户通过设置在自定义的<code>VertxRestAccessLogItemMeta</code>中的<code>AccessLogItemCreator</code>实例化自己的<code>AccessLogItem</code>。由于这是一个函数式接口，当<code>AccessLogItem</code>的初始化方式较简单时，可以直接使用Lambda表达式定义Creator，以简化开发。</p>
<h4 id="accesslogitemmeta">AccessLogItemMeta的匹配规则</h4>
<p>AccessLogItemMeta加载进Parser后，会进行一次排序。Parser解析pattern串时会从前到后匹配meta list，总的匹配规则如下：
1. 优先匹配高优先级的meta。
2. 优先匹配有后缀的meta，当匹配上多个有后缀meta时，取前后缀相距最小的一个。
3. 优先匹配占位符长的meta，例如有两个meta，"%abc"和"%a"，如果匹配中了"%abc"则直接返回，不再匹配"%a"。</p>
<h4 id="_7">示例说明</h4>
<ol>
<li>扩展自定义AccessLogItem</li>
</ol>
<p>首先用户需要<code>AccessLogItem</code>接口实现自己的item：
  ```java
  public class UserDefinedAccessLogItem implements AccessLogItem<RoutingContext> {
    private String config;</p>
<pre><code>public UserDefinedAccessLogItem(String config) {
  this.config = config;
}

@Override
public String getFormattedItem(AccessLogParam&lt;RoutingContext&gt; accessLogParam) {
  // 此处是用户自定义的逻辑，需要从AccessLogParam或其他地方取相关数据，生成并返回access log片段
  return "user-defined-[" + config + "]-[" + accessLogParam.getStartMillisecond() + "]";
}
</code></pre>
<p>}
  ```</p>
<ol>
<li>定义AccessLogItem的meta类</li>
</ol>
<p>继承<code>VertxRestAccessLogItemMeta</code>或<code>CompositeVertxRestAccessLogItemMeta</code>类，定义AccessLogItem的前后缀等信息：
  ```java
  public class UserDefinedCompositeExtendedAccessLogItemMeta extends CompositeVertxRestAccessLogItemMeta {
    private static final List<VertxRestAccessLogItemMeta> META_LIST = new ArrayList&lt;&gt;();</p>
<pre><code>static {
  META_LIST.add(new VertxRestAccessLogItemMeta("%{", "}user-defined", UserDefinedAccessLogItem::new));
}

@Override
public List&lt;VertxRestAccessLogItemMeta&gt; getAccessLogItemMetas() {
  return META_LIST;
}
</code></pre>
<p>}
  ```</p>
<ol>
<li>配置SPI加载文件</li>
</ol>
<p>在<code>resources/META-INF/services/</code>目录下定义一个名为"org.apache.servicecomb.transport.rest.vertx.accesslog.parser.VertxRestAccessLogItemMeta"的文件，将上一步中定义的meta类完整类名填写到该文件中，供Parser加载meta类。</p>
<ol>
<li>配置Access Log的pattern</li>
</ol>
<p>在microservice.yaml文件中的配置pattern，假设为"%{test-config}user-defined"，运行服务触发Access Log打印，假设请求开始时间为1，则可以看到Access Log打印内容为"user-defined-[test-config]-[1]"。</p>
<h2 id="_8">示例代码</h2>
<h3 id="microserviceyaml">microservice.yaml文件中的配置</h3>
<pre><code class="yaml">## other configurations omitted
servicecomb:
  accesslog:
    enabled: true  ## 启用access log
    pattern: &quot;%h - - %t %r %s %B&quot;  ## 自定义日志格式
</code></pre>

<h3 id="log4jproperties">log4j.properties文件中的配置</h3>
<pre><code class="properties"># access log configuration item
paas.logs.accesslog.dir=../logs/
paas.logs.accesslog.file=access.log
# access log File appender
log4j.appender.access.MaxBackupIndex=10
log4j.appender.access.MaxFileSize=20MB
log4j.appender.access.logPermission=rw-------
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../build-consumer/common-configuration/" class="btn btn-neutral float-right" title="消费者通用配置项">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../bootup/" class="btn btn-neutral" title="程序启动逻辑"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../bootup/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../../build-consumer/common-configuration/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>

</body>
</html>
